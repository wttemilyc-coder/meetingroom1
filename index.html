<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœƒè­°å®¤é ç´„ App (V4.1)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 40px rgba(0,0,0,0.08); position: relative; overflow: hidden; }
        .glass-header { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="app" class="app-container flex flex-col">
    
    <header class="glass-header sticky top-0 z-20 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <button @click="prevUnit" class="w-8 h-8 rounded-full text-gray-400 hover:bg-gray-100 active:scale-95 transition">
                <i class="fa-solid fa-chevron-left text-sm"></i>
            </button>
            <button @click="showDatePicker = true" class="p-1 rounded-lg hover:bg-gray-100">
                <h1 class="text-xl font-bold text-gray-800">{{ currentYear }}å¹´ {{ currentMonth + 1 }}æœˆ</h1>
                <div class="flex items-center justify-center gap-2">
                    <span class="w-2 h-2 rounded-full" :class="dbConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                    <p class="text-xs text-gray-500 font-medium">{{ dbConnected ? 'é›²ç«¯å·²é€£ç·š' : 'è«‹è¨­å®šè³‡æ–™åº«' }}</p>
                </div>
            </button>
            <button @click="nextUnit" class="w-8 h-8 rounded-full text-gray-400 hover:bg-gray-100 active:scale-95 transition">
                <i class="fa-solid fa-chevron-right text-sm"></i>
            </button>
        </div>
        
        <div class="flex items-center gap-2">
            <div class="inline-flex rounded-full bg-gray-100 p-0.5">
                <button @click="currentView = 'month'" class="px-3 py-1 text-xs font-semibold rounded-full transition-all"
                        :class="currentView === 'month' ? 'bg-white shadow text-blue-600' : 'text-gray-500'">æœˆ</button>
                <button @click="currentView = 'week'" class="px-3 py-1 text-xs font-semibold rounded-full transition-all"
                        :class="currentView === 'week' ? 'bg-white shadow text-blue-600' : 'text-gray-500'">é€±</button>
            </div>
            <button @click="resetToToday" class="w-9 h-9 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-sm font-bold shadow-sm active:scale-95 transition">ä»Š</button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar pb-24">
        
        <div v-if="currentView === 'month'" class="px-4 py-4">
            <div class="grid grid-cols-7 mb-2">
                <div v-for="day in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']" :key="day" class="text-center text-xs text-gray-400 font-medium py-2">{{ day }}</div>
            </div>
            <div class="grid grid-cols-7 gap-y-2 gap-x-1">
                <div v-for="n in startDayOfWeek" :key="'empty-'+n"></div>
                <div v-for="date in daysInMonth" :key="date" 
                     @click="selectDate(date)" @dblclick="handleDayDblClick(date)"
                     class="relative flex flex-col items-center justify-center h-12 rounded-2xl transition-all cursor-pointer"
                     :class="getDateClass(date)">
                    <span class="text-sm font-medium z-10">{{ date }}</span>
                    <div class="flex gap-0.5 mt-1" v-if="hasBooking(date)"><span class="w-1 h-1 rounded-full bg-blue-500"></span></div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'week'" class="px-4 py-4">
             <div class="grid grid-cols-7 gap-x-1">
                <div v-for="day in weekDaysList" :key="day.date"
                     @click="selectDate(day.day)" @dblclick="handleDayDblClick(day.day)"
                     class="relative flex flex-col items-center justify-center h-16 rounded-2xl transition-all cursor-pointer"
                     :class="getDateClass(day.day, day.month, day.year)">
                    <span class="text-[10px] font-medium z-10" :class="day.isCurrentMonth ? 'text-gray-500' : 'text-gray-400'">{{ day.label }}</span>
                    <span class="text-sm font-bold z-10 mt-1">{{ day.day }}</span>
                    <div class="flex gap-0.5 mt-1" v-if="hasBooking(day.day, day.month, day.year)"><span class="w-1 h-1 rounded-full bg-blue-500"></span></div>
                </div>
            </div>
        </div>

        <div class="px-6 mt-2 relative min-h-[200px]">
            <div class="flex items-center justify-between mb-4 sticky top-0 bg-white/95 backdrop-blur py-2 z-10">
                <h2 class="text-lg font-bold text-gray-800">
                    {{ currentMonth + 1 }}æœˆ{{ selectedDate }}æ—¥ è¡Œç¨‹
                </h2>
                <span class="text-xs font-medium px-2 py-1 bg-gray-100 rounded-lg text-gray-500">{{ getWeekDay(selectedDate) }}</span>
            </div>

            <div v-if="isLoading" class="flex justify-center py-10">
                <div class="loading-spinner"></div>
            </div>
            <div v-else-if="dayBookings.length === 0" class="flex flex-col items-center justify-center py-10 text-gray-400">
                <i class="fa-regular fa-calendar-plus text-4xl mb-3 opacity-20"></i>
                <p class="text-sm">é»æ“Šå³ä¸‹è§’æˆ–**é›™æ“Šæ—¥æœŸ**æ–°å¢é ç´„</p>
            </div>
            <transition-group name="list" tag="div" class="space-y-3">
                <div v-for="booking in dayBookings" :key="booking.id" 
                     class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-start gap-4 relative overflow-hidden group">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5" :class="getRoomColor(booking.room)"></div>
                    <div class="flex flex-col items-center min-w-[3.5rem]">
                        <span class="text-sm font-bold text-gray-800">{{ booking.startTime }}</span>
                        <span class="text-[10px] text-gray-400 my-0.5">|</span>
                        <span class="text-xs text-gray-500">{{ booking.endTime }}</span>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-sm font-bold text-gray-800 leading-tight">{{ booking.title }}</h3>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-[10px] px-2 py-0.5 rounded-md font-medium bg-gray-50 text-gray-600 border border-gray-200">{{ booking.room }}</span>
                            <span class="text-[10px] text-gray-400"><i class="fa-regular fa-user mr-1"></i>{{ booking.user }}</span>
                        </div>
                    </div>
                    <button @click="deleteBooking(booking.id)" class="opacity-0 group-hover:opacity-100 transition text-gray-300 hover:text-red-500 px-2">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </transition-group>
        </div>
    </main>

    <button @click="showModal = true" class="fixed bottom-8 right-6 w-14 h-14 bg-gradient-to-br from-blue-600 to-blue-500 text-white rounded-full shadow-lg shadow-blue-500/40 flex items-center justify-center text-xl active:scale-90 transition z-30 hover:shadow-xl hover:-translate-y-1">
        <i class="fa-solid fa-plus"></i>
    </button>

    <transition name="slide-up">
        <div v-if="showModal" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center">
            <div @click="showModal = false" class="absolute inset-0 bg-black/30 backdrop-blur-sm transition-opacity"></div>
            
            <div class="bg-white w-full max-w-[480px] rounded-t-3xl sm:rounded-3xl p-6 relative z-10 shadow-2xl pb-10 sm:pb-6">
                <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-xl font-bold text-gray-800 mb-6">æ–°å¢é ç´„ ({{ currentMonth + 1 }}æœˆ{{ selectedDate }}æ—¥)</h3>
                
                <div class="space-y-5">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">é¸æ“‡ç©ºé–“</label>
                        <div class="flex gap-2 mt-1">
                            <button v-for="room in rooms" :key="room" @click="newBooking.room = room"
                                    class="flex-1 px-4 py-2.5 rounded-xl text-sm font-medium border transition-all whitespace-nowrap"
                                    :class="newBooking.room === room ? 'border-blue-500 bg-blue-50 text-blue-700 shadow-sm' : 'border-gray-200 text-gray-500 bg-white'">
                                {{ room }}
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">ä½¿ç”¨äºº (å¿…å¡«)</label>
                        <input v-model="newBooking.user" type="text" class="w-full mt-1 bg-gray-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-300" placeholder="è¼¸å…¥æ‚¨çš„åå­—">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">æœƒè­°ä¸»é¡Œ (å¿…å¡«)</label>
                        <input v-model="newBooking.title" type="text" class="w-full mt-1 bg-gray-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-300" placeholder="ä¾‹å¦‚ï¼šç”¢å“é€±æœƒ">
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">æ˜¯å¦ç‚ºæ•´æ—¥é ç´„ï¼Ÿ</label>
                        <input type="checkbox" v-model="newBooking.isAllDay" class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">é–‹å§‹æ™‚é–“</label>
                            <input v-model="newBooking.startTime" type="time" class="w-full mt-1 bg-gray-50 border-none rounded-xl px-4 py-3 text-sm outline-none" :disabled="newBooking.isAllDay">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">çµæŸæ™‚é–“</label>
                            <input v-model="newBooking.endTime" type="time" class="w-full mt-1 bg-gray-50 border-none rounded-xl px-4 py-3 text-sm outline-none" :disabled="newBooking.isAllDay">
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">çµæŸæ—¥æœŸ (é ç´„å¤šæ—¥)</label>
                        <input v-model="newBooking.endDateString" type="date" class="w-full mt-1 bg-gray-50 border-none rounded-xl px-4 py-3 text-sm outline-none">
                    </div>
                    
                    <div>
                        <p v-if="!isTimeValid" class="text-xs text-red-500 font-medium">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i> çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼
                        </p>
                        <div v-else-if="conflictInfo.hasConflict">
                             <label class="text-xs font-bold text-red-500 uppercase tracking-wider">åµæ¸¬åˆ°é ç´„è¡çªï¼</label>
                             <div class="mt-1 flex flex-wrap gap-2">
                                <span class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded-lg font-medium">
                                    {{ conflictInfo.conflictingTimes[0] }}... ç­‰å…± {{ conflictInfo.count }} ç­†è¡çª
                                </span>
                             </div>
                        </div>
                        <div v-else-if="roomSchedulePreview.length > 0">
                            <label class="text-xs font-bold text-red-500 uppercase tracking-wider">è©²æœƒè­°å®¤å·²é ç´„æ™‚æ®µï¼š</label>
                            <div class="mt-1 flex flex-wrap gap-2">
                                <span v-for="(time, index) in roomSchedulePreview" :key="index"
                                      class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded-lg font-medium">
                                    {{ time }}
                                </span>
                            </div>
                        </div>
                        <div v-else class="text-xs mt-1 text-green-600">
                            <i class="fa-solid fa-circle-check mr-1"></i> {{ newBooking.room }} è©²æ™‚æ®µç›®å‰ç„¡é ç´„ã€‚
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-8">
                    <button @click="showModal = false" class="flex-1 py-3.5 rounded-xl bg-gray-100 text-gray-600 font-semibold text-sm">å–æ¶ˆ</button>
                    <button @click="submitBooking" 
                            :disabled="!canSubmit"
                            class="flex-1 py-3.5 rounded-xl bg-blue-600 text-white font-semibold text-sm shadow-lg shadow-blue-600/20 active:scale-95 transition disabled:opacity-50">
                        {{ isSubmitting ? 'è™•ç†ä¸­...' : 'ç¢ºèªé ç´„' }}
                    </button>
                </div>
            </div>
        </div>
    </transition>
    
    <transition name="fade">
        <div v-if="showDatePicker" class="fixed inset-0 z-40 flex items-center justify-center">
            <div @click="showDatePicker = false" class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
            
            <div class="bg-white p-6 rounded-2xl shadow-xl z-10 w-80">
                <h3 class="text-lg font-bold mb-4">é¸æ“‡æ—¥æœŸ</h3>
                <div class="flex gap-4">
                    <select v-model="tempYear" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-3 text-base">
                        <option v-for="y in yearOptions" :value="y">{{ y }}å¹´</option>
                    </select>
                    <select v-model="tempMonth" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-3 text-base">
                        <option v-for="m in 12" :value="m - 1">{{ m }}æœˆ</option>
                    </select>
                </div>
                
                <button @click="setYearMonth(tempYear, tempMonth)" class="w-full mt-6 py-3 bg-blue-600 text-white rounded-xl font-semibold active:scale-95 transition">
                    ç¢ºå®š
                </button>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    // ==========================================
    // ğŸ”¥ è«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„ FIREBASE è¨­å®š ğŸ”¥
    // ==========================================
    // ** å·²æ›¿æ›ç‚ºæ‚¨æä¾›çš„é‡‘é‘° **
    const firebaseConfig = {
        apiKey: "AIzaSyBTd5BByNfFkE__ijBjdyK1Y7-E7Ha8-A8",
        authDomain: "meeting-room-69546.firebaseapp.com",
        projectId: "meeting-room-69546",
        storageBucket: "meeting-room-69546.firebasestorage.app",
        messagingSenderId: "476938976498",
        appId: "1:476938976498:web:130b1ccba749b69ae0a46b",
        // measurementId: "G-M4W4DHTGC6" // Analytics ä¸åŠ å…¥ç›¸å®¹ç‰ˆ
    };

    let db = null;
    let dbConnected = false;
    
    // æª¢æŸ¥ä¸¦åˆå§‹åŒ– Firebase
    if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "ä½ çš„_API_KEY") {
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            dbConnected = true;
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
        }
    }

    // è¼”åŠ©å‡½å¼ï¼šå°‡ YYYY-MM-DD è½‰ç‚º Date ç‰©ä»¶
    function parseDateString(dateString) {
        if (!dateString) return null;
        const [year, month, day] = dateString.split('-').map(Number);
        return new Date(year, month - 1, day);
    }
    
    // è¼”åŠ©å‡½å¼ï¼šæª¢æŸ¥æ™‚é–“ç¯„åœæ˜¯å¦é‡ç–Š
    function checkTimeOverlap(startA, endA, startB, endB) {
        return startA < endB && endA > startB;
    }


    createApp({
        setup() {
            const today = new Date();
            const currentYear = ref(today.getFullYear());
            const currentMonth = ref(today.getMonth());
            const selectedDate = ref(today.getDate());
            const showModal = ref(false);
            const isLoading = ref(true);
            const isSubmitting = ref(false);
            const bookings = ref([]);
            const rooms = ['4æ¨“æœƒè­°å®¤', '6æ¨“æœƒè­°å®¤'];

            const todayISO = today.toISOString().substring(0, 10);

            const newBooking = ref({
                title: '',
                room: rooms[0],
                startTime: '10:00',
                endTime: '11:00',
                user: '',
                isAllDay: false, 
                endDateString: todayISO 
            });

            // ç›£è½ isAllDay è®ŠåŒ–ï¼Œèª¿æ•´æ™‚é–“
            watch(() => newBooking.value.isAllDay, (isAllDay) => {
                if (isAllDay) {
                    newBooking.value.startTime = '09:00';
                    newBooking.value.endTime = '17:00';
                } else if (newBooking.value.startTime === '09:00' && newBooking.value.endTime === '17:00') {
                    newBooking.value.startTime = '10:00';
                    newBooking.value.endTime = '11:00';
                }
            });

            // ç•¶æ—¥æœŸè®ŠåŒ–æ™‚ï¼Œæ›´æ–° endDateString ç¢ºä¿é è¨­æ˜¯ç•¶å¤©
            watch(selectedDate, () => {
                const dateObj = new Date(currentYear.value, currentMonth.value, selectedDate.value);
                newBooking.value.endDateString = dateObj.toISOString().substring(0, 10);
            }, { immediate: true });
            watch(currentMonth, () => {
                const dateObj = new Date(currentYear.value, currentMonth.value, selectedDate.value);
                newBooking.value.endDateString = dateObj.toISOString().substring(0, 10);
            });
            watch(currentYear, () => {
                const dateObj = new Date(currentYear.value, currentMonth.value, selectedDate.value);
                newBooking.value.endDateString = dateObj.toISOString().substring(0, 10);
            });


            // --- æ ¸å¿ƒé©—è­‰èˆ‡é è¦½ ---

            // 1. æª¢æŸ¥æ™‚é–“æœ‰æ•ˆæ€§ (çµæŸæ™‚é–“ > é–‹å§‹æ™‚é–“)
            const isTimeValid = computed(() => {
                return newBooking.value.endTime > newBooking.value.startTime;
            });

            // 2. é ç´„è¡çªæª¢æŸ¥ (UI é è¦½ - Selected Date Only)
            const roomSchedulePreview = computed(() => {
                const preview = bookings.value.filter(b => {
                    const bDate = new Date(b.date);
                    const matchesDate = bDate.getFullYear() === currentYear.value &&
                                        bDate.getMonth() === currentMonth.value &&
                                        bDate.getDate() === selectedDate.value;
                    const matchesRoom = b.room === newBooking.value.room;
                    return matchesDate && matchesRoom;
                }).sort((a, b) => a.startTime.localeCompare(b.startTime));

                return preview.map(b => `${b.startTime} - ${b.endTime} (${b.user})`);
            });
            
            // 3. å³æ™‚è¡çªè¨Šæ¯ (æäº¤å‰çš„åš´æ ¼æª¢æŸ¥ - Selected Date Only)
            const conflictInfo = computed(() => {
                if (!isTimeValid.value) return { hasConflict: false };

                const newStart = newBooking.value.startTime;
                const newEnd = newBooking.value.endTime;

                const relevantBookings = bookings.value.filter(b => {
                    const bDate = new Date(b.date);
                    const isToday = bDate.getFullYear() === currentYear.value &&
                                    bDate.getMonth() === currentMonth.value &&
                                    bDate.getDate() === selectedDate.value;
                    return isToday && b.room === newBooking.value.room;
                });

                const conflictingTimes = [];
                for (const existingBooking of relevantBookings) {
                    if (checkTimeOverlap(newStart, newEnd, existingBooking.startTime, existingBooking.endTime)) {
                        conflictingTimes.push(`${existingBooking.startTime} - ${existingBooking.endTime} (${existingBooking.user})`);
                    }
                }

                return {
                    hasConflict: conflictingTimes.length > 0,
                    count: conflictingTimes.length,
                    conflictingTimes: conflictingTimes
                };
            });

            // 4. æäº¤æŒ‰éˆ•ç‹€æ…‹
            const canSubmit = computed(() => {
                // æª¢æŸ¥ dbConnected, å¿…å¡«æ¬„ä½, æ™‚é–“æœ‰æ•ˆæ€§, è¡çªæª¢æŸ¥
                return dbConnected && 
                       newBooking.value.user && 
                       newBooking.value.title && 
                       isTimeValid.value && 
                       !conflictInfo.value.hasConflict && 
                       !isSubmitting.value;
            });


            // --- æ ¸å¿ƒæ–¹æ³• (åŒ…å«å¤šæ—¥é ç´„é‚è¼¯) ---

            // æª¢æŸ¥å–®æ—¥é ç´„è¡çª (ç”¨æ–¼å¤šæ—¥è¿´åœˆ)
            const checkSingleDayConflict = (dateObj, room, startTime, endTime) => {
                const dateISO = dateObj.toISOString().substring(0, 10);
                
                const relevantBookings = bookings.value.filter(b => {
                    return b.date.substring(0, 10) === dateISO && b.room === room;
                });
                
                for (const existingBooking of relevantBookings) {
                    if (checkTimeOverlap(startTime, endTime, existingBooking.startTime, existingBooking.endTime)) {
                        return { 
                            isConflict: true, 
                            date: dateISO, 
                            time: `${existingBooking.startTime} - ${existingBooking.endTime}` 
                        };
                    }
                }
                return { isConflict: false };
            };

            // æäº¤é ç´„ (V4.1)
            const submitBooking = async () => {
                if (!canSubmit.value) {
                    // å†æ¬¡æª¢æŸ¥éŒ¯èª¤åŸå› ï¼Œæä¾›ç”¨æˆ¶æ›´æ˜ç¢ºçš„æç¤º
                    if (!dbConnected) alert("éŒ¯èª¤ï¼šé›²ç«¯è³‡æ–™åº«å°šæœªé€£ç·šï¼Œè«‹æª¢æŸ¥ Firebase è¨­å®šã€‚");
                    else if (!newBooking.value.user || !newBooking.value.title) alert("éŒ¯èª¤ï¼šè«‹å¡«å¯«ä½¿ç”¨äººå’Œæœƒè­°ä¸»é¡Œã€‚");
                    else if (!isTimeValid.value) alert("éŒ¯èª¤ï¼šçµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼");
                    else if (conflictInfo.value.hasConflict) alert("éŒ¯èª¤ï¼šè©²æ™‚æ®µèˆ‡ç¾æœ‰é ç´„è¡çªï¼Œè«‹æª¢æŸ¥å¾Œå†è©¦ã€‚");
                    return;
                }

                isSubmitting.value = true;
                const room = newBooking.value.room;
                const startT = newBooking.value.startTime;
                const endT = newBooking.value.endTime;
                const user = newBooking.value.user;
                const title = newBooking.value.title;
                
                const startDate = new Date(currentYear.value, currentMonth.value, selectedDate.value);
                const endDate = parseDateString(newBooking.value.endDateString);
                
                if (endDate < startDate) {
                     alert("éŒ¯èª¤ï¼šçµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸï¼");
                     isSubmitting.value = false;
                     return;
                }

                const datesToBook = [];
                let currentDate = new Date(startDate);
                
                while (currentDate <= endDate) {
                    datesToBook.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                try {
                    // 1. é æª¢æŸ¥æ‰€æœ‰æ—¥æœŸçš„è¡çª
                    for (const dateObj of datesToBook) {
                        const conflict = checkSingleDayConflict(dateObj, room, startT, endT);
                        if (conflict.isConflict) {
                            alert(`é ç´„å¤±æ•—ï¼š${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥ åµæ¸¬åˆ°æ™‚é–“è¡çª (${conflict.time})ï¼Œè«‹æª¢æŸ¥ï¼`);
                            isSubmitting.value = false;
                            return;
                        }
                    }

                    // 2. å¯«å…¥ Firebase
                    const batch = db.batch();
                    datesToBook.forEach(dateObj => {
                        const bookingRef = db.collection("bookings").doc();
                        batch.set(bookingRef, {
                            title: title,
                            room: room,
                            startTime: startT,
                            endTime: endT,
                            user: user,
                            // é€™è£¡ä½¿ç”¨ ISOString å­˜å„²ï¼Œä½†åªä¿ç•™æ—¥æœŸéƒ¨åˆ†ä»¥æ–¹ä¾¿å‰ç«¯è™•ç†
                            date: dateObj.toISOString(), 
                            createdAt: new Date().toISOString()
                        });
                    });

                    await batch.commit();

                    alert(`æˆåŠŸé ç´„ ${datesToBook.length} å¤©ï¼`);
                    showModal.value = false;
                    newBooking.value.title = '';
                    newBooking.value.isAllDay = false;

                } catch (e) {
                    alert("é ç´„å¤±æ•—ï¼š" + e.message);
                } finally {
                    isSubmitting.value = false;
                }
            };
            
            // åˆªé™¤é ç´„ (ä¿æŒä¸è®Š)
            const deleteBooking = async (id) => {
                if(!confirm('ç¢ºå®šè¦å–æ¶ˆé€™å€‹é ç´„å—ï¼Ÿ')) return;
                if(!dbConnected) return;
                
                try {
                    await db.collection("bookings").doc(id).delete();
                } catch (e) {
                    console.error(e);
                }
            };


            // --- Computed & Helper Functions (ä¿æŒä¸è®Š) ---

            const dayBookings = computed(() => {
                return bookings.value.filter(b => {
                    const bDate = new Date(b.date);
                    return bDate.getFullYear() === currentYear.value &&
                           bDate.getMonth() === currentMonth.value &&
                           bDate.getDate() === selectedDate.value;
                }).sort((a, b) => a.startTime.localeCompare(b.startTime));
            });
            const yearOptions = computed(() => { 
                const arr = [];
                for(let i = currentYear.value - 5; i <= currentYear.value + 5; i++) {
                    arr.push(i);
                }
                return arr;
            });
            const daysInMonth = computed(() => new Date(currentYear.value, currentMonth.value + 1, 0).getDate());
            const startDayOfWeek = computed(() => new Date(currentYear.value, currentMonth.value, 1).getDay());
            const weekDaysList = computed(() => { 
                const dayList = [];
                const anchorDate = new Date(currentYear.value, currentMonth.value, selectedDate.value);
                const startOfWeek = new Date(anchorDate);
                startOfWeek.setDate(anchorDate.getDate() - anchorDate.getDay()); 

                for (let i = 0; i < 7; i++) {
                    const current = new Date(startOfWeek);
                    current.setDate(startOfWeek.getDate() + i);

                    dayList.push({
                        date: current.toISOString().substring(0, 10),
                        year: current.getFullYear(),
                        month: current.getMonth(),
                        day: current.getDate(),
                        label: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][current.getDay()],
                        isCurrentMonth: current.getMonth() === currentMonth.value 
                    });
                }
                return dayList;
            });
            const getWeekDay = (day) => {
                const date = new Date(currentYear.value, currentMonth.value, day);
                return ['æ˜ŸæœŸæ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
            };
            const getDateClass = (day, month = currentMonth.value, year = currentYear.value) => {
                const isSelected = day === selectedDate.value && month === currentMonth.value && year === currentYear.value;
                const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                
                let classes = '';
                if (isSelected) classes += 'bg-blue-600 text-white shadow-md shadow-blue-500/30 transform scale-105';
                else if (isToday) classes += 'text-blue-600 bg-blue-50 font-bold';
                else classes += 'text-gray-700 hover:bg-gray-100';

                if (currentView.value === 'week' && month !== currentMonth.value) {
                    classes += ' opacity-50';
                }

                return classes;
            };
            const hasBooking = (day, month = currentMonth.value, year = currentYear.value) => {
                return bookings.value.some(b => {
                    const bDate = new Date(b.date);
                    return bDate.getDate() === day && bDate.getMonth() === month && bDate.getFullYear() === year;
                });
            };
            const getRoomColor = (room) => {
                const colors = { '4æ¨“æœƒè­°å®¤': 'bg-fuchsia-500', '6æ¨“æœƒè­°å®¤': 'bg-teal-500'};
                return colors[room] || 'bg-gray-400';
            };


            // --- å°èˆªèˆ‡æ—¥æœŸé¸æ“‡æ–¹æ³• (ä¿æŒä¸è®Š) ---

            const selectDate = (day) => {
                selectedDate.value = day;
                if (currentView.value === 'week') {
                    const clickedDayInfo = weekDaysList.value.find(d => d.day === day);
                    if (clickedDayInfo) {
                        currentMonth.value = clickedDayInfo.month;
                        currentYear.value = clickedDayInfo.year;
                    }
                }
            };
            const handleDayDblClick = (day) => {
                selectDate(day);
                showModal.value = true;
            };
            const resetToToday = () => {
                const now = new Date();
                currentYear.value = now.getFullYear();
                currentMonth.value = now.getMonth();
                selectedDate.value = now.getDate();
                currentView.value = 'month';
            };
            const prevUnit = () => {
                if (currentView.value === 'month') {
                    if (currentMonth.value === 0) { currentMonth.value = 11; currentYear.value--; } 
                    else { currentMonth.value--; }
                } else {
                    const newDate = new Date(currentYear.value, currentMonth.value, selectedDate.value);
                    newDate.setDate(newDate.getDate() - 7);
                    currentYear.value = newDate.getFullYear();
                    currentMonth.value = newDate.getMonth();
                    selectedDate.value = newDate.getDate();
                }
            };
            const nextUnit = () => {
                 if (currentView.value === 'month') {
                    if (currentMonth.value === 11) { currentMonth.value = 0; currentYear.value++; } 
                    else { currentMonth.value++; }
                } else {
                    const newDate = new Date(currentYear.value, currentMonth.value, selectedDate.value);
                    newDate.setDate(newDate.getDate() + 7);
                    currentYear.value = newDate.getFullYear();
                    currentMonth.value = newDate.getMonth();
                    selectedDate.value = newDate.getDate();
                }
            };
            const setYearMonth = (year, month) => {
                currentYear.value = year;
                currentMonth.value = month;
                selectedDate.value = 1;
                showDatePicker.value = false;
                currentView.value = 'month';
            };


            // --- Firebase é›²ç«¯äº’å‹• ---
            onMounted(() => {
                if (!dbConnected) { isLoading.value = false; return; }
                db.collection("bookings").onSnapshot((snapshot) => {
                    bookings.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    isLoading.value = false;
                });
            });


            return {
                dbConnected, currentYear, currentMonth, selectedDate, daysInMonth, startDayOfWeek,
                selectDate, handleDayDblClick, prevUnit, nextUnit, resetToToday,
                getDateClass, getWeekDay, dayBookings, hasBooking,
                showModal, rooms, newBooking, roomSchedulePreview, getRoomColor,
                isLoading, isSubmitting, submitBooking, deleteBooking,
                currentView, weekDaysList, showDatePicker, 
                isTimeValid, conflictInfo, canSubmit,
                yearOptions, tempYear: currentYear.value, tempMonth: currentMonth.value, setYearMonth,
            };
        }
    }).mount('#app');
</script>
</body>
</html>
